name: Cache
description: 'Caches cargo dependencies'
runs:
  using: composite
  steps:
    - uses: actions/cache@v3 
      with: 
        path: | 
          ~/.cargo/ 
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.toml') }}
        
    - name: Download dependencies
      run: |
          # Ensure all dependencies are downloaded - both for our crates and for
          # tools we use in CI. We don't care about these tools succeeding for
          # two reasons: First, this entire job is best-effort since it's just a
          # performance optimization. Second, there may be failures due to
          # issues other than failing to download dependencies (e.g., `cargo
          # metadata` called with a malformed `Cargo.toml`, build failure in our
          # own crate or in dependencies, etc). For those reasons, we discard
          # stderr and ignore status codes.
          #
          # For downloading our crates' dependencies in particular, note that
          # there is no support for doing this directly [1], so we just check
          # all crates using --tests.
          #
          # [1]  https://stackoverflow.com/a/42139535/836390
          cargo check --workspace --tests            &> /dev/null || true
          cargo metadata                             &> /dev/null || true
          cargo install cargo-readme --version 3.2.0 &> /dev/null || true
          cargo install --locked kani-verifier       &> /dev/null || true
          cargo kani setup                           &> /dev/null || true
      shell: bash
